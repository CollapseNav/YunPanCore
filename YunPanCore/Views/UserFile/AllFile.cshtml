@model IEnumerable<Model.FileInfo>

    @{
    ViewBag.Title = "AllFile";
    Layout = "~/Views/Shared/AboutFiles.cshtml";
    }
    <div style="width: 100%;height: 30px;padding-left: 15px;">
        <span class="layui-breadcrumb" style="position: relative;top: 50%;" id="Fill">
        </span>
    </div>
    <table class="layui-table" id="AllFileTable" lay-filter="DataTable"></table>

    <script type="text/html" id="tablebar">
        <button class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</button>
        <button class="layui-btn layui-btn-xs layui-btn-normal" lay-event="share">分享</button>
        <button class="layui-btn layui-btn-xs layui-btn-normal" lay-event="download">下载</button>
    </script>

    <script type="text/html" id="FileToolBar">
        <button class="layui-btn layui-btn-sm" lay-event="newfolder">新建文件夹</button>
        <button class="layui-btn layui-btn-sm" id="UploadBtn" lay-event="upload">上传</button>
        <div style="display: inline-table;overflow: hidden;position: relative;bottom: 0%;">
            <span class="layui-btn layui-btn-sm">上传文件夹</span>
            <input class="uploadfile" style="position: absolute;right: 0;top: 0;opacity: 0;" type="file"
                id="UploadFiles" multiple webkitdirectory />
        </div>
    </script>

    <script>
        layui.use(['table', 'upload', 'util', 'element'], function () {
            var table = layui.table;
            var layer = parent.layer === undefined ? layui.layer : parent.layer,
                $ = layui.jquery;
            var util = layui.util;
            var upload = layui.upload;
            var element = layui.element;
            var fill = $('#Fill');

            fill.click(function (ele) {
                tablebody.reload({
                    url: '/UserFile/InitAllFiles',
                    where: {
                        'folder': ele.toElement.getAttribute('value')
                    }
                });
                setTimeout(() => {
                    InitFill();
                    UploadRender();
                }, 50);
            });

            //展示已知数据
            var tablebody = table.render({
                elem: '#AllFileTable',
                url: '/UserFile/InitAllFiles',
                toolbar: '#FileToolBar',
                text: {
                    none: '空空如也，和你的钱包一样' //默认：无数据。注：该属性为 layui 2.2.5 开始新增
                },
                defaultToolbar: [],
                cols: [
                    [ //标题栏
                        {
                            type: "checkbox",
                            unresize: true
                        }, {
                            field: 'FileName',
                            title: '文件名',
                            sort: true,
                            unresize: true
                        }, {
                            fixed: "right",
                            title: "操作",
                            toolbar: "#tablebar",
                            width: '15%',
                            unresize: true
                        }, {
                            field: 'FileType',
                            title: '文件类型',
                            sort: true,
                            width: '6%',
                            unresize: true
                        }, {
                            field: 'FileSize',
                            title: '文件大小',
                            sort: true,
                            width: '10%',
                            unresize: true
                        }, {
                            field: 'OwnerName',
                            title: '所有者',
                            width: '10%',
                            unresize: true
                        }, {
                            field: 'ChangedDate',
                            sort: true,
                            title: '修改时间',
                            templet: function (date) {
                                return util.toDateString(date.ChangedDate,
                                    'yyyy-MM-dd HH:mm:ss');
                            },
                            width: '15%',
                            unresize: true
                        }
                    ]
                ]
            });

            function InitFill() {
                fill.innerHTML = '';
                var a = document.createElement('a');
                a.setAttribute('value', '');
                a.innerHTML = 'Root';
                fill.html(a);
                $.post('/UserFile/GetCurrDir', {}, function (res) {
                    var paths = res.split('/');
                    var value = '';
                    for (var i = 2; i < paths.length; i += 1) {
                        var a = document.createElement('a');
                        value += paths[i];
                        a.setAttribute('value', value);
                        a.innerText = '    /    ' + paths[i];
                        fill.append(a);
                        value += '/';
                    }
                })
            }
            InitFill();

            function UploadRender() {
                upload.render({
                    elem: '#UploadBtn',
                    url: '/UserFile/Upload',
                    accept: 'file',
                    done: function (res) {
                        if (res == '1') {
                            layer.msg('上传成功！');
                            setTimeout(() => {
                                fill[0].lastChild.click();
                            }, 500);
                        } else {
                            layer.msg(res);
                        }
                    }
                });
            };
            UploadRender();

            //头顶工具栏
            table.on('toolbar(DataTable)', function (obj) {
                var checkStatus = table.checkStatus(obj.config.id);
                switch (obj.event) {
                    case 'newfolder': {
                        layer.prompt({
                            title: '新建文件夹'
                        }, function (val, index) {
                            $.post('/UserFile/NewFolder', {
                                'FolderName': val
                            }, function (res) {
                                layer.msg(res);
                            });
                            layer.close(index);
                            setTimeout(() => {
                                fill[0].lastChild.click();
                            }, 500);
                        });
                        break;
                    }
                }
            });

            //表内工具栏
            table.on('tool(DataTable)', function (obj) {
                var data = obj.data;
                switch (obj.event) {
                    case 'del': {
                        $.post('/UserFile/Delete', {
                            'id': data.Id
                        }, function (res) {
                            layer.msg('删除成功！');
                            setTimeout(() => {
                                fill[0].lastChild.click();
                            }, 500)
                        });
                        break;
                    }
                    case 'share': {
                        var fof = data.FileType;
                        if (fof != 'Folder') {
                            $.post('/UserFile/ShareFile', {
                                'id': data.Id
                            }, function (res) {
                                layer.msg('分享成功！');
                            });
                        }
                        else {
                            $.post('/UserFile/ShareFolder', {
                                'id': data.Id
                            }, function (res) {
                                layer.msg('分享文件夹成功！');
                            });
                        }
                        break;
                    }
                    case 'download': {
                        // $.get('/UserFile/DownLoadFile', {
                        //     'fileid': data.Id
                        // }, function (res) {
                        //     var a = document.createElement('a');
                        //     var blob = new Blob([res]);
                        //     a.href = URL.createObjectURL(blob);
                        //     a.click();
                        // })
                        var a = document.createElement('a');
                        a.href = '/UserFile/DownLoadFile?fileid=' + data.Id;
                        a.click();
                    }
                }
            });

            //双击事件
            table.on('rowDouble(DataTable)', function (obj) {
                var data = obj.data;
                var filetype = data["FileType"];
                switch (filetype) {
                    case 'Folder': {
                        tablebody.reload({
                            url: '/UserFile/DoubleClick',
                            where: {
                                'folder': data["FileName"]
                            }
                        });
                        setTimeout(() => {
                            InitFill();
                            UploadRender();
                        }, 50);
                        break;
                    }
                    default: {
                        break;
                    }
                }
            });

            //左侧导航栏
            element.on('nav(leftside)', function (elem) {
                fill.html('');
                var value = elem.context.getAttribute('target');
                if (elem.context.getAttribute('target') == null) {
                    tablebody.reload({
                        url: '/UserFile/InitAllFiles',
                        where: {
                            'folder': ''
                        }
                    })
                } else if (value == 'Shared') {
                    tablebody.reload({
                        url: '/UserFile/GetSharedFiles',
                        where: {}
                    })
                } else {
                    tablebody.reload({
                        url: '/UserFile/InitFilteFiles',
                        where: {
                            'filte': value
                        }
                    });
                }
                setTimeout(() => {
                    InitFill();
                    UploadRender();
                }, 50);
            });

        });
    </script>